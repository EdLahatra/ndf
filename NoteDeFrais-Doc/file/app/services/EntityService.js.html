<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">app/services/EntityService.js | API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  <a href="test.html" data-ice="testLink">Test</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/index.js~Index.html">Index</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">components</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/components/DepenseCommuneNavBar.js~DepenseCommuneNavBar.html">DepenseCommuneNavBar</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/components/NavBar.js~NavBar.html">NavBar</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/components/datepicker-field-factory.js~DatePicker.html">DatePicker</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/components/datepicker.js~DatePicker.html">DatePicker</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/components/distance.js~Distance.html">Distance</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/components/icon-field-factory.js~IconFieldFactory.html">IconFieldFactory</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/components/image-field-factory.js~ImageFieldFactory.html">ImageFieldFactory</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/components/list-edit-with-menu.js~ListEditWithMenu.html">ListEditWithMenu</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/components/list-edit.js~ListEdit.html">ListEdit</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/components/place-autocomplete.js~PlaceAutocomplete.html">PlaceAutocomplete</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/components/realm-form.js~RealmForm.html">RealmForm</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/components/select-field-factory.js~SelectFieldFactory.html">SelectFieldFactory</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/components/select.js~Select.html">Select</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/components/textbox-field-factory.js~Textbox.html">Textbox</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/components/valeursAnalytiques-autocomplete.js~PlaceAutocomplete.html">PlaceAutocomplete</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Component">Component</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">errors</div><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-ApiServiceAccess">ApiServiceAccess</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">lib</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/lib/Logger.js~Logger.html">Logger</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-createIconSet">createIconSet</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">routes</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/routes/CategorieDepenseForm.js~CategorieDepenseForm.html">CategorieDepenseForm</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/routes/CategorieDepenseListe.js~CategorieDepenseListe.html">CategorieDepenseListe</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/routes/CategorieDepenseSelection.js~CategorieDepenseSelection.html">CategorieDepenseSelection</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/routes/Chargement.js~Chargement.html">Chargement</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/routes/Connexion.js~Connexion.html">Connexion</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/routes/DepenseCommuneHistoriqueListe.js~DepenseCommuneHistoriqueListe.html">DepenseCommuneHistoriqueListe</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/routes/DepenseCommuneListe.js~DepenseCommuneListe.html">DepenseCommuneListe</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/routes/DepenseForm.js~DepenseCommuneForm.html">DepenseCommuneForm</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/routes/FichePersonnelleForm.js~FichePersonnelleForm.html">FichePersonnelleForm</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/routes/IndemniteKilometriqueForm.js~IndemniteKilometriqueForm.html">IndemniteKilometriqueForm</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/routes/Login.js~Login.html">Login</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/routes/NoteDeFraisListe.js~NoteDeFraisListe.html">NoteDeFraisListe</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/routes/Presentation.js~Presentation.html">Presentation</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/routes/VehiculeForm.js~VehiculeForm.html">VehiculeForm</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/routes/VehiculeListe.js~VehiculeListe.html">VehiculeListe</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">schemas</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/schemas/AxeAnalytique.js~AxeAnalytique.html">AxeAnalytique</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/schemas/BaremeKilometrique.js~BaremeKilometrique.html">BaremeKilometrique</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/schemas/CategorieDepense.js~CategorieDepense.html">CategorieDepense</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/schemas/CompteSecure.js~CompteSecure.html">CompteSecure</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/schemas/Configuration.js~Configuration.html">Configuration</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/schemas/Depense.js~Depense.html">Depense</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/schemas/FichePersonnelle.js~FichePersonnelle.html">FichePersonnelle</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/schemas/Identifiant.js~Identifiant.html">Identifiant</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/schemas/IndemniteKilometrique.js~IndemniteKilometrique.html">IndemniteKilometrique</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/schemas/Justificatif.js~Justificatif.html">Justificatif</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/schemas/KilometreAnnuel.js~KilometreAnnuel.html">KilometreAnnuel</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/schemas/NoteDeFrais.js~NoteDeFrais.html">NoteDeFrais</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/schemas/Regulation.js~Regulation.html">Regulation</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/schemas/Seuil.js~Seuil.html">Seuil</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/schemas/ValeurAnalytique.js~ValeurAnalytique.html">ValeurAnalytique</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/schemas/Vehicule.js~Vehicule.html">Vehicule</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-TYPES">TYPES</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-STATUTS">STATUTS</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">services</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/services/ApiService.js~ApiService.html">ApiService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/services/AxeAnalytiqueService.js~AxeAnalytiqueService.html">AxeAnalytiqueService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/services/BaremeKilometriqueService.js~BaremeKilometriqueService.html">BaremeKilometriqueService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/services/CategorieDepenseService.js~CategorieDepenseService.html">CategorieDepenseService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/services/CompteSecureService.js~CompteSecureService.html">CompteSecureService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/services/CompteService.js~CompteService.html">CompteService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/services/ConfigurationService.js~ConfigurationService.html">ConfigurationService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/services/DepenseService.js~DepenseService.html">DepenseService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/services/EntityService.js~EntityService.html">EntityService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/services/FichePersonnelleService.js~FichePersonnelleService.html">FichePersonnelleService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/services/IndemniteKilometriqueService.js~IndemniteKilometriqueService.html">IndemniteKilometriqueService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/services/JustificatifService.js~JustificatifService.html">JustificatifService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/services/NoteDeFraisService.js~NoteDeFraisService.html">NoteDeFraisService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/services/RealmService.js~RealmService.html">RealmService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/services/ValeurAnalytiqueService.js~ValeurAnalytiqueService.html">ValeurAnalytiqueService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/services/VehiculeService.js~VehiculeService.html">VehiculeService</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">styles</div><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-style">style</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Style">Style</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">app/services/EntityService.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import RealmService from &apos;../services/RealmService&apos;;
import CompteSecureService from &apos;../services/CompteSecureService&apos;;
import ConfigurationService from &apos;../services/ConfigurationService&apos;;
import ApiService from &apos;../services/ApiService&apos;;
import Utils from &apos;../lib/utils&apos;;
import moment from &apos;moment&apos;;
import _ from &apos;underscore&apos;;
import ApiServiceAccess from &apos;../errors/ApiServiceAccess&apos;;

const API_PATH_CONFIG = {
  &apos;AxeAnalytique&apos;: {
    apiPath: &apos;axesAnalytiques&apos;,
    entity: require(&apos;../schemas/AxeAnalytique&apos;)
  },
  &apos;BaremeKilometrique&apos;: {
    apiPath: &apos;baremesKilometriques&apos;,
    entity: require(&apos;../schemas/BaremeKilometrique&apos;)
  },
  &apos;CategorieDepense&apos;: {
    apiPath: &apos;categoriesDepenses&apos;,
    entity: require(&apos;../schemas/CategorieDepense&apos;)
  },
  &apos;Compte&apos;: {
    apiPath: &apos;comptes&apos;,
    entity: require(&apos;../schemas/Compte&apos;)
  },
  &apos;Depense&apos;: {
    apiPath: &apos;depenses&apos;,
    entity: require(&apos;../schemas/Depense&apos;)
  },
  &apos;FichePersonnelle&apos;: {
    apiPath: &apos;fichesPersonnelles&apos;,
    entity: require(&apos;../schemas/FichePersonnelle&apos;)
  },
  &apos;IndemniteKilometrique&apos;: {
    apiPath: &apos;indemnitesKilometriques&apos;,
    entity: require(&apos;../schemas/IndemniteKilometrique&apos;)
  },
  &apos;Justificatif&apos;: {
    apiPath: &apos;justificatifs&apos;,
    entity: require(&apos;../schemas/Justificatif&apos;)
  },
  &apos;KilometreAnnuel&apos;: {
    entity: require(&apos;../schemas/KilometreAnnuel&apos;)
  },
  &apos;NoteDeFrais&apos;: {
    apiPath: &apos;notesDeFrais&apos;,
    entity: require(&apos;../schemas/NoteDeFrais&apos;)
  },
  &apos;Seuil&apos;: {
    entity: require(&apos;../schemas/Seuil&apos;)
  },
  &apos;ValeurAnalytique&apos;: {
    apiPath: &apos;valeursAnalytiques&apos;,
    entity: require(&apos;../schemas/ValeurAnalytique&apos;)
  },
  &apos;Vehicule&apos;: {
    apiPath: &apos;vehicules&apos;,
    entity: require(&apos;../schemas/Vehicule&apos;)
  }
};

/**
 * Service de gestion des entit&#xE9;s
 */
export default class EntityService {

  /**
   * Initialisation du service
   * Initialisation de l&apos;ensemble des services utiles pour le chargement des donn&#xE9;es.
   */
  constructor (schema) {
    /** @type {Object} */
    this.schema = schema;
    /** @type {RealmService.service} */
    this.service = RealmService.service;
    /** @type {Object} */
    this.apiPath = API_PATH_CONFIG[this.schema.name].apiPath;
    /** @type {CompteSecureService} */
    this.compteSecureService = new CompteSecureService();
    /** @type {ApiService} */
    this.apiService = new ApiService();
    /** @type {ConfigurationService} */
    this.configurationService = new ConfigurationService();
  }

  /**
   * Supprime l&apos;ensemble des &#xE9;l&#xE9;ments de la liste des identifiants
   * @param {array} idList
   */
  deleteAll (idList) {
    idList.forEach((id) =&gt; {
      const object = this.find(id);
      if (object) {
        this.delete(object);
      }
    });
  }

  /**
   * Ajoute un listener sur la base de donn&#xE9;es pour la synchronisation
   * @param shouldUseApiService
   * @private
   */
  _listen (shouldUseApiService) {
    if (shouldUseApiService) {
      this.service.addListener(&apos;change&apos;, this._synchronise.bind(this));
    }
  }

  /**
   * Supprime les listeners sur la base de donn&#xE9;es
   * @param shouldUseApiService
   * @private
   */
  _removeListen (shouldUseApiService) {
    if (shouldUseApiService) {
      this.service.removeAllListeners();
    }
  }

  /**
   * M&#xE9;thode de cr&#xE9;ation d&apos;une entit&#xE9; en local et de synchonisation  avec le serveur si le compte peut utiliser l&apos;api.
   * @param body
   * @returns {string} identifiant
   */
  create (body) {
    const shouldUseApiService = this.compteSecureService.shouldUseApiService();
    this._listen(shouldUseApiService);

    body.id = Utils.uuid();

    this.service.write(() =&gt; {
      body._isSynchronized = !shouldUseApiService;
      body.derniereModification = new Date();
      this.service.create(this.schema.name, body);
    });

    this._removeListen(shouldUseApiService);
    return body.id;
  }

  /**
   * M&#xE9;thode de mise &#xE0; jour d&apos;une entit&#xE9; en local et de synchonisation avec le serveur si le compte peut utiliser l&apos;api.
   * @param body
   * @returns {string} identifiant
   */
  update (body) {
    const shouldUseApiService = this.compteSecureService.shouldUseApiService();
    this._listen(shouldUseApiService);

    this.service.write(() =&gt; {
      body._isSynchronized = !shouldUseApiService;
      body.derniereModification = new Date();
      this.service.create(this.schema.name, body, true);
    });

    this._removeListen(shouldUseApiService);
    return body.id;
  }

  /**
   * M&#xE9;thode permettant de mettre &#xE0; jour la date de depr&#xE9;ciation sur une entit&#xE9;e
   * Deux dates sont mise &#xE0; jour, car pour certaines entit&#xE9;s le serveur ne d&#xE9;finit pas de date de d&#xE9;priciation,
   * ici le fonctionnement est toujours le m&#xEA;mes
   * @param data
   * @returns {Object}
   */
  setDepreciation (data) {
    data.depreciation = new Date();
    data._depreciation = new Date();
    return data;
  }

  /**
   * M&#xE9;thode de suppression d&apos;une entit&#xE9; et de synchonisation avec le serveur.
   * Les &#xE9;lements ne sont pas r&#xE9;ellement supprim&#xE9;s, ils sont d&#xE9;pr&#xE9;ci&#xE9;s
   * @param body
   * @returns {string}
   */
  delete (body) {
    const shouldUseApiService = this.compteSecureService.shouldUseApiService();
    this._listen(shouldUseApiService);

    let data = _.clone(body);
    data = this.setDepreciation(data);
    data._isSynchronized = !shouldUseApiService;
    data.derniereModification = new Date();
    this.service.write(() =&gt; {
      this.service.create(this.schema.name, data, true);
    });

    this._removeListen(shouldUseApiService);
    return body.id;
  }

  /**
   * Filtre permettant de ne pas prendre en compte les &#xE9;l&#xE9;ments &quot;supprim&#xE9;s&quot;
   * @param object
   * @returns {*}
   * @private
   */
  _depreciationFilter (object) {
    if (object.depreciation || object._depreciation) {
      return moment(object.depreciation || object._depreciation).isAfter(moment());
    }
    return true;
  }

  /**
   * M&#xE9;thode de recherche par identifiant en base de donn&#xE9;es
   * @param id
   * @returns {Object}
   */
  find (id) {
    const object = this.service.objects(this.schema.name).filtered(`id = &quot;${id}&quot;`)[0];
    if (object &amp;&amp; this._depreciationFilter(object)) {
      return object;
    }
    return null;
  }

  /**
   * M&#xE9;thode de recherche par identifiant en base de donn&#xE9;es et de mise au format pour l&apos;api
   * @param id
   * @returns {Object}
   */
  findAndFormat (id) {
    return this.format(this.find(id));
  }

  /**
   * M&#xE9;thode qui retourne l&apos;ensemble des entit&#xE9;s
   * @param filtered
   * @returns {Array}
   */
  findAll (filtered = null) {
    let all = this.service.objects(this.schema.name);
    if (filtered) {
      all = all.filtered(filtered);
    }

    return _.toArray(all)
            .filter((object) =&gt; {
              return this._depreciationFilter(object)
            });
  }

  /**
   * M&#xE9;thode qui retourne l&apos;ensemble des entit&#xE9;s li&#xE9; &#xE0; un compte
   * @param idCompte
   * @returns {Array}
   */
  findAllForAccount (idCompte) {
    return this.findAll(`idCompte = &quot;${idCompte}&quot;`);
  }

  /**
   * M&#xE9;thode de synchronisation des donn&#xE9;es avec l&apos;api
   * @returns Promise
   * @private
   */
  async _synchronise () {
    if (this.schema.properties._isSynchronized) {
      const objectsToSync = RealmService.service.objects(this.schema.name).filtered(&apos;_isSynchronized = false&apos;);

      if (objectsToSync &amp;&amp; objectsToSync.length &gt; 0) {
        const _syncDatabase = (id) =&gt; {
          const object = this.find(id);
          if (object) {
            this.service.write(() =&gt; object._isSynchronized = true);
          }
        };

        console.log(`--- Service synchronise ${objectsToSync.length} ${this.schema.name}(s)`);
        const promises = objectsToSync.map((object) =&gt; {
          const data = this.format(object);
          if (object.depreciation || object._depreciation) {
            return this.apiService.delete(this.apiPath, data, [object.id]).then(() =&gt; _syncDatabase(object.id));
          }
          console.log(&apos;---- update &apos;, this.schema.name);
          return this.apiService.put(this.apiPath, data).then(() =&gt; _syncDatabase(object.id));
        });

        return await Promise.all(promises);
      }

    }
    return Promise.resolve(true);
  }

  /**
   * M&#xE9;thode de merge des donn&#xE9;es.
   * Le merge consiste &#xE0; synchroniser les donn&#xE9;es avec le serveur puis &#xE0; les r&#xE9;cup&#xE9;rer.
   * Pour chaque entit&#xE9;s, une date de derni&#xE8;re mise &#xE0; jour est stock&#xE9; dans le compte pour optimiser les &#xE9;changes avec le serveur.
   * @returns Promise
   */
  async mergeAll () {
    await this._synchronise();

    let collection = null;
    let lastFecthAll = this.compteSecureService.getLastFetchAll(this.schema.name);
    const nextLastFetchAll = new Date();
    if (lastFecthAll) {
      collection = await this.fetchAll({ derniereMiseAJour: moment(lastFecthAll).subtract(5, &apos;minutes&apos;).format() });
    }
    else {
      collection = await this.fetchAll();
    }

    if (collection &amp;&amp; collection.length &gt; 0) {
      console.log(`--- Service mergeAll ${collection.length} ${this.schema.name}(s)`);
      return await Promise.all(collection).then((elements) =&gt; {
        this.service.write(() =&gt; {
          elements.forEach((element) =&gt; {
            try {
              element._isSynchronized = true;
              this.service.create(this.schema.name, element, true);
            } catch (e) {
              console.log(&apos;error&apos;, e, element);
            }
          });
          console.log(&apos;-------------------------------------------------------&apos;);
        });
        this.compteSecureService.setLastFetchAll(this.schema.name, nextLastFetchAll);
        return elements;
      });

    }
    return Promise.resolve([]);
  }

  /**
   * M&#xE9;thode permettant de merger un objet en partculier.
   * Le syst&#xE8;me est identique au merge des list d&apos;entit&#xE9;s
   * @param id
   * @returns {Promise}
   */
  async merge (id) {
    const object = await this.fetch(id);
    if (object) {
      return Promise.resolve(object).then((element) =&gt; {
        this.service.write(() =&gt; {
          element._isSynchronized = true;
          this.service.create(this.schema.name, element, true);
        });
        return element;
      });
    }
    return Promise.resolve(false);
  };

  /**
   * M&#xE9;thode qui permet de r&#xE9;cup&#xE9;rer l&apos;ensemble des &#xE9;l&#xE9;ments pour une entit&#xE9;
   * @param queryParams
   * @returns {Promise}
   */
  async fetchAll (queryParams = { derniereMiseAJour: moment([1970, 0, 1]).format() }) {
    try {
      return await this.apiService.get(this.apiPath, [], queryParams).then((objects) =&gt; {
        return _.map(objects, (object) =&gt; {
          return this.parse(object);

        });
      })
    } catch (error) {
      if (error instanceof ApiServiceAccess) {
        throw error;
      }
      console.log(&apos;--- FetchAll - Find in local db :&apos;, this.apiPath, error);
      return new Promise.resolve(this.findAll);
    }

  }

  /**
   * M&#xE9;thode qui permet de r&#xE9;cup&#xE9;rer un &#xE9;l&#xE9;ment d&apos;une entit&#xE9; par son identifiant
   * @param id
   * @param queryParams
   * @returns {Promise}
   */
  async fetch (id, queryParams = { derniereMiseAJour: moment([1970, 0, 1]).format() }) {
    try {

      return await this.apiService.get(this.apiPath, [id], queryParams).then((object) =&gt; {
        return this.parse(object);
      });

    } catch (error) {
      if (error instanceof ApiServiceAccess) {
        throw error;
      }
      else if (error instanceof SyntaxError) {
        //TODO: show error
        //Server response 500/503
        //throw error;`
        return new Promise.resolve(this.find(id));
      }
      else if (error instanceof TypeError) {
        // No network...
        return new Promise.resolve(this.find(id));
      }

    }
  }

  /**
   * M&#xE9;thode qui parse les &#xE9;lements en retour du serveur en fonction de la d&#xE9;finition des objets realm.
   * @param object
   * @param schema
   * @returns {Object}
   */
  parse (object, schema = this.schema) {
    if (schema.name) {
      const properties = schema.properties;
      const keys = Object.keys(properties);

      for (let key of keys) {

        if (object &amp;&amp; object.hasOwnProperty(key)) {
          const value = properties[key];

          const type = typeof value === &apos;object&apos; ? value.type : value;

          const objectValue = object[key];

          if (type === &apos;date&apos; &amp;&amp; objectValue) {
            object[key] = moment.utc(objectValue).toDate();
          }
          else if (type === &apos;int&apos;) {
            object[key] = objectValue ? parseInt(objectValue, 10) : 0;
          }
          else if (type === &apos;float&apos;) {
            object[key] = objectValue ? this.parseFloat(objectValue) : 0;
          }
          else if (type === &apos;bool&apos;) {
            object[key] = objectValue === &apos;true&apos;;
          }
          else if (type === &apos;list&apos;) {
            if (value.objectType === &apos;Identifiant&apos;) {
              const identifiants = [];
              for (let id of objectValue) {
                identifiants.push({ id });
              }
              object[key] = identifiants;
            }
            else if (value.objectType) {

              const objectType = API_PATH_CONFIG[value.objectType];
              if (objectType &amp;&amp; objectType.entity) {
                const childSchema = objectType.entity.default.schema;
                object[key] = _.toArray(objectValue).map((value) =&gt; {
                  return this.parse(value, childSchema);
                });
              }

            }

          }
          else if (type === &apos;string&apos; &amp;&amp; typeof objectValue === &apos;object&apos;) {
            object[key] = JSON.stringify(objectValue);
          }

        }

      }

    }

    return object;
  }

  /**
   * M&#xE9;thode qui formatte les &#xE9;lements &#xE0; destination du serveur en fonction de la d&#xE9;finition des objets realm.
   * @param object
   * @param schema
   * @returns {Object}
   */
  format (object, schema = this.schema) {

    const properties = schema.properties;
    const keys = Object.keys(properties);
    const format = {};
    for (let key of keys) {
      if (!key.startsWith(&apos;_&apos;) &amp;&amp; object &amp;&amp; object.hasOwnProperty(key)) {
        const value = properties[key];

        const type = typeof value === &apos;object&apos; ? value.type : value;

        const objectValue = object[key];

        if (type === &apos;date&apos;) {
          format[key] = objectValue ? moment.utc(objectValue).format() : objectValue;
        }
        else if (type === &apos;list&apos;) {
          if (value.objectType === &apos;Identifiant&apos;) {
            format[key] = objectValue.map((obj) =&gt; obj.id);
          }
          else {
            format[key] = _.toArray(objectValue);
          }
        }
        else if (type === &apos;bool&apos;) {
          format[key] = objectValue === true ? &apos;true&apos; : &apos;false&apos;;
        }
        else if (type === &apos;float&apos;) {
          format[key] = objectValue ? this.parseFloat(objectValue) : 0;
        }
        else {
          format[key] = objectValue;
        }

      }
    }
    return format
  }

  /**
   * M&#xE9;thode qui permet de parser un float
   * @param value
   * @returns {number}
   */
  parseFloat (value) {
    if (value) {
      value = (Math.round(parseFloat(value) * 100) / 100);
    }
    return value;
  }

};</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.4.8)</span></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
