<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">unit/services/NoteDeFraisService-test.js | API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  <a href="test.html" data-ice="testLink">Test</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/index.js~Index.html">Index</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">components</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/components/DepenseCommuneNavBar.js~DepenseCommuneNavBar.html">DepenseCommuneNavBar</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/components/NavBar.js~NavBar.html">NavBar</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/components/datepicker-field-factory.js~DatePicker.html">DatePicker</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/components/datepicker.js~DatePicker.html">DatePicker</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/components/distance.js~Distance.html">Distance</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/components/icon-field-factory.js~IconFieldFactory.html">IconFieldFactory</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/components/image-field-factory.js~ImageFieldFactory.html">ImageFieldFactory</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/components/list-edit-with-menu.js~ListEditWithMenu.html">ListEditWithMenu</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/components/list-edit.js~ListEdit.html">ListEdit</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/components/place-autocomplete.js~PlaceAutocomplete.html">PlaceAutocomplete</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/components/realm-form.js~RealmForm.html">RealmForm</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/components/select-field-factory.js~SelectFieldFactory.html">SelectFieldFactory</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/components/select.js~Select.html">Select</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/components/textbox-field-factory.js~Textbox.html">Textbox</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/components/valeursAnalytiques-autocomplete.js~PlaceAutocomplete.html">PlaceAutocomplete</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Component">Component</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">errors</div><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-ApiServiceAccess">ApiServiceAccess</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">lib</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/lib/Logger.js~Logger.html">Logger</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-createIconSet">createIconSet</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">routes</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/routes/CategorieDepenseForm.js~CategorieDepenseForm.html">CategorieDepenseForm</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/routes/CategorieDepenseListe.js~CategorieDepenseListe.html">CategorieDepenseListe</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/routes/CategorieDepenseSelection.js~CategorieDepenseSelection.html">CategorieDepenseSelection</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/routes/Chargement.js~Chargement.html">Chargement</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/routes/Connexion.js~Connexion.html">Connexion</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/routes/DepenseCommuneHistoriqueListe.js~DepenseCommuneHistoriqueListe.html">DepenseCommuneHistoriqueListe</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/routes/DepenseCommuneListe.js~DepenseCommuneListe.html">DepenseCommuneListe</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/routes/DepenseForm.js~DepenseCommuneForm.html">DepenseCommuneForm</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/routes/FichePersonnelleForm.js~FichePersonnelleForm.html">FichePersonnelleForm</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/routes/IndemniteKilometriqueForm.js~IndemniteKilometriqueForm.html">IndemniteKilometriqueForm</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/routes/Login.js~Login.html">Login</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/routes/NoteDeFraisListe.js~NoteDeFraisListe.html">NoteDeFraisListe</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/routes/Presentation.js~Presentation.html">Presentation</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/routes/VehiculeForm.js~VehiculeForm.html">VehiculeForm</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/routes/VehiculeListe.js~VehiculeListe.html">VehiculeListe</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">schemas</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/schemas/AxeAnalytique.js~AxeAnalytique.html">AxeAnalytique</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/schemas/BaremeKilometrique.js~BaremeKilometrique.html">BaremeKilometrique</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/schemas/CategorieDepense.js~CategorieDepense.html">CategorieDepense</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/schemas/CompteSecure.js~CompteSecure.html">CompteSecure</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/schemas/Configuration.js~Configuration.html">Configuration</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/schemas/Depense.js~Depense.html">Depense</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/schemas/FichePersonnelle.js~FichePersonnelle.html">FichePersonnelle</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/schemas/Identifiant.js~Identifiant.html">Identifiant</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/schemas/IndemniteKilometrique.js~IndemniteKilometrique.html">IndemniteKilometrique</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/schemas/Justificatif.js~Justificatif.html">Justificatif</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/schemas/KilometreAnnuel.js~KilometreAnnuel.html">KilometreAnnuel</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/schemas/NoteDeFrais.js~NoteDeFrais.html">NoteDeFrais</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/schemas/Regulation.js~Regulation.html">Regulation</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/schemas/Seuil.js~Seuil.html">Seuil</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/schemas/ValeurAnalytique.js~ValeurAnalytique.html">ValeurAnalytique</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/schemas/Vehicule.js~Vehicule.html">Vehicule</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-TYPES">TYPES</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-STATUTS">STATUTS</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">services</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/services/ApiService.js~ApiService.html">ApiService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/services/AxeAnalytiqueService.js~AxeAnalytiqueService.html">AxeAnalytiqueService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/services/BaremeKilometriqueService.js~BaremeKilometriqueService.html">BaremeKilometriqueService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/services/CategorieDepenseService.js~CategorieDepenseService.html">CategorieDepenseService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/services/CompteSecureService.js~CompteSecureService.html">CompteSecureService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/services/CompteService.js~CompteService.html">CompteService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/services/ConfigurationService.js~ConfigurationService.html">ConfigurationService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/services/DepenseService.js~DepenseService.html">DepenseService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/services/EntityService.js~EntityService.html">EntityService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/services/FichePersonnelleService.js~FichePersonnelleService.html">FichePersonnelleService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/services/IndemniteKilometriqueService.js~IndemniteKilometriqueService.html">IndemniteKilometriqueService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/services/JustificatifService.js~JustificatifService.html">JustificatifService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/services/NoteDeFraisService.js~NoteDeFraisService.html">NoteDeFraisService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/services/RealmService.js~RealmService.html">RealmService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/services/ValeurAnalytiqueService.js~ValeurAnalytiqueService.html">ValeurAnalytiqueService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/services/VehiculeService.js~VehiculeService.html">VehiculeService</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">styles</div><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-style">style</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Style">Style</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">unit/services/NoteDeFraisService-test.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import { describe, it } from &apos;mocha&apos;;
import { assert, expect } from &apos;chai&apos;;
import _ from &apos;underscore&apos;;

import { STATUTS }  from &apos;../../../app/schemas/NoteDeFrais&apos;;
import CompteService  from &apos;../../../app/services/CompteService&apos;;
import IndemniteKilometriqueService from &apos;../../../app/services/IndemniteKilometriqueService&apos;;
import VehiculeService from &apos;../../../app/services/VehiculeService&apos;;
import NoteDeFraisService  from &apos;../../../app/services/NoteDeFraisService&apos;;
import RealmService  from &apos;../../../app/services/RealmService&apos;;

import moment from &apos;moment&apos;;

const seuilVariable = 0.6;
const ikDistance = 100;
const mockBaremeKmService = {
  findSeuil() {
    return {
      variable: seuilVariable
    };
  },

  findByTypeVehicule() {
    return {};
  }
};

const mockCompteSecureService = {
  shouldUseApiService(){
    return false;
  }
};

describe(&apos;NoteDeFraisService&apos;, () =&gt; {

  let indemniteKilometriqueService, noteDeFraisService, db, compteService, vehiculeService;
  const idCompte = &apos;foobar&apos;;
  let ndfList = [];

  beforeEach(function () {
    compteService = new CompteService();
    vehiculeService = new VehiculeService();
    indemniteKilometriqueService = new IndemniteKilometriqueService();
    indemniteKilometriqueService.baremeKilometriqueService = mockBaremeKmService;
    noteDeFraisService = new NoteDeFraisService();
    noteDeFraisService.indemniteKilometriqueService = indemniteKilometriqueService;
    noteDeFraisService.compteSecureService = mockCompteSecureService;
    noteDeFraisService.baremeKilometriqueService = mockBaremeKmService;

    db = RealmService.service;
    assert.isNotNull(indemniteKilometriqueService);
    db.write(()=&gt; {
      db.create(&apos;FichePersonnelle&apos;, { id: &apos;ff&apos;, idCompte: idCompte, nom: &apos;foo&apos;, prenom: &apos;bar&apos;, email: &apos;foo@bar&apos; });
      db.create(&apos;Compte&apos;, { id: idCompte, idFichePersonnelle: &apos;ff&apos; });

      db.create(&apos;Vehicule&apos;, {
        idCompte: idCompte,
        id: &apos;car0&apos;,
        nom: &apos;car 0&apos;,
        puissanceFiscale: 5,
        kilometreAnnuel: [{ kilometrage: 0, annee: 2016 }],
        typeVehicule: &apos;Voiture&apos;
      });

      db.create(&apos;Vehicule&apos;, {
        idCompte: idCompte,
        id: &apos;car1&apos;,
        nom: &apos;car 1&apos;,
        puissanceFiscale: 7,
        kilometreAnnuel: [{ kilometrage: 5000, annee: 2016 }],
        typeVehicule: &apos;Voiture&apos;
      });

    });
    for (let i = 0; i &lt; 10; i++) {
      const ndfID = noteDeFraisService.create({
        id: `idndf${i}`,
        idCompte,
        statut: STATUTS.validated.key
      });
      const ndf = noteDeFraisService.find(ndfID);

      for (let j = 0; j &lt; 10; j++) {

        const date = moment().add(j, &apos;day&apos;).toDate();
        indemniteKilometriqueService.create({
          id: &apos;foobar&apos;,
          _depart: &apos;Lille&apos;,
          lieu: &apos;Paris&apos;,
          idVehicule: `car${j % 2}`,
          date,
          distance: ikDistance,
          montantARembourser: ikDistance * seuilVariable
        }, ndf);
      }
      ndfList.push(ndf);
    }

  });

  afterEach(function () {
    ndfList = [];
    db.write(()=&gt; {
      db.delete(db.objects(&apos;FichePersonnelle&apos;));
      db.delete(db.objects(&apos;Compte&apos;));
      db.delete(db.objects(&apos;NoteDeFrais&apos;));
      db.delete(db.objects(&apos;IndemniteKilometrique&apos;));
      db.delete(db.objects(&apos;Regulation&apos;));
      db.delete(db.objects(&apos;Vehicule&apos;));
    });

  });

  it(&apos;should find note de frais in progress&apos;, () =&gt; {
    const compte = compteService.find(idCompte);
    db.write(()=&gt; {
      ndfList[0].statut = STATUTS.inProgress.key;
    });
    const id = noteDeFraisService.findEnCours(compte);
    assert.equal(ndfList[0].id, id);
  });

  it(&apos;should throw error severals note de frais is in progress&apos;, () =&gt; {
    const compte = compteService.find(idCompte);
    db.write(()=&gt; {
      ndfList[0].statut = STATUTS.inProgress.key;
      ndfList[1].statut = STATUTS.inProgress.key;
    });
    expect(noteDeFraisService.findEnCours.bind(noteDeFraisService, compte)).to.throw(Error);
  });

  it(&apos;should not delete noteDeFrais with service&apos;, () =&gt; {
    const compte = compteService.find(idCompte);
    expect(noteDeFraisService.delete.bind(noteDeFraisService, compte)).to.throw(Error);
  });

  it(&apos;should not validate ndf with no depenses or ik &apos;, () =&gt; {
    const compte = compteService.find(idCompte);
    const noteDeFrais = noteDeFraisService.find(noteDeFraisService.findEnCours(compte));
    expect(noteDeFraisService.validate.bind(noteDeFraisService, compte, noteDeFrais)).to.throw(Error);
  });

  it(&apos;should validate ndf&apos;, () =&gt; {
    const compte = compteService.find(idCompte);
    db.write(()=&gt; {
      ndfList[0].statut = STATUTS.inProgress.key;
    });

    const newNdf = noteDeFraisService.validate(compte, ndfList[0]);

    assert.isNotNull(newNdf);
    assert.equal(ndfList[0].statut, STATUTS.validated.key);
    assert.notEqual(newNdf.id, ndfList[0].id);
    assert.equal(newNdf.idCompte, compte.id);
    assert.equal(newNdf.statut, STATUTS.inProgress.key);
    assert.deepEqual(newNdf.indemnitesKilometriques, {});
  });

  it(&apos;should validate ndf without regulation&apos;, () =&gt; {
    const compte = compteService.find(idCompte);
    db.write(()=&gt; {
      ndfList[0].statut = STATUTS.inProgress.key;
    });

    const newNdf = noteDeFraisService.validate(compte, ndfList[0]);

    assert.isNotNull(newNdf);
    assert.equal(ndfList[0].statut, STATUTS.validated.key);
    assert.notEqual(newNdf.id, ndfList[0].id);
    assert.equal(newNdf.idCompte, compte.id);
    assert.equal(newNdf.statut, STATUTS.inProgress.key);

    const ikRegulationList = _.toArray(db.objects(&apos;Regulation&apos;).filtered(`idNoteDeFrais = &quot;${ndfList[0].id}&quot;`));

    assert.equal(ikRegulationList.length, 0);

  });

  it(&apos;should validate ndf with regulation&apos;, () =&gt; {
    const compte = compteService.find(idCompte);
    db.write(()=&gt; {
      ndfList[0].statut = STATUTS.inProgress.key;
    });

    const change = -0.5;
    const fixe = 859;
    const idVehicule = &apos;car0&apos;;
    const vehicule = vehiculeService.find(idVehicule);
    noteDeFraisService.baremeKilometriqueService = {
      findSeuil() {
        return {
          variable: seuilVariable + change,
          fixe: fixe
        }
      },
      findByTypeVehicule() {
        return {};
      }
    };

    assert.equal(vehicule.kilometreAnnuel[0].kilometrage, 0);

    const newNdf = noteDeFraisService.validate(compte, ndfList[0]);

    assert.isNotNull(newNdf);
    assert.equal(ndfList[0].statut, STATUTS.validated.key);
    assert.notEqual(newNdf.id, ndfList[0].id);
    assert.equal(newNdf.idCompte, compte.id);
    assert.equal(newNdf.statut, STATUTS.inProgress.key);

    const ikRegulationList = _.toArray(db.objects(&apos;Regulation&apos;).filtered(`idNoteDeFrais = &quot;${ndfList[0].id}&quot;`));

    assert.equal(ikRegulationList.length, 2);
    const ikRegulation = ikRegulationList[0];

    assert.equal(ikRegulation.idVehicule, idVehicule);
    assert.equal(ikRegulation.montantARembourser, -250);

    assert.equal(vehicule.kilometreAnnuel[0].kilometrage, 5 * ikDistance);

  });

  it(&apos;should find all for account and status&apos;, ()=&gt; {
    const ndfList = noteDeFraisService.findAllForAccountAndStatus(idCompte, STATUTS.validated.key);
    assert.equal(_.toArray(ndfList).length, 10);
  });

  it(&apos;should find all others depenses&apos;, () =&gt; {
    const all = noteDeFraisService.findAllDepenses(null);
    assert.equal(all.length, 0);
  });

  it(&apos;should get first depense commune date&apos;, ()=&gt; {
    const all = noteDeFraisService.findAllDepenses(ndfList[0]);
    const date = noteDeFraisService.getFirstDepenseCommuneDate(all);
    assert.equal(moment(date).format(&apos;DD/MM/YYYY&apos;), moment().format(&apos;DD/MM/YYYY&apos;));
  });

  it(&apos;should get last depense commune date&apos;, ()=&gt; {
    const all = noteDeFraisService.findAllDepenses(ndfList[0]);
    const date = noteDeFraisService.getLastDepenseCommuneDate(all);
    assert.equal(moment(date).format(&apos;DD/MM/YYYY&apos;), moment().add(9, &apos;day&apos;).format(&apos;DD/MM/YYYY&apos;));
  });

  it(&apos;should get null for first depense commune date if depense list is null&apos;, ()=&gt; {
    const date = noteDeFraisService.getFirstDepenseCommuneDate(null);
    assert.isNull(date);
  });

  it(&apos;should get null for last depense commune date if depense list is empty&apos;, ()=&gt; {
    const date = noteDeFraisService.getLastDepenseCommuneDate([]);
    assert.isNull(date);
  });

  it(&apos;should update total&apos;, () =&gt; {
    assert.equal(ndfList[0].totalDepenses, 0);
    assert.equal(ndfList[0].totalIndemnitesKilometriques, 0);
    noteDeFraisService.updateTotal(ndfList[0]);
    assert.equal(ndfList[0].totalDepenses, 0);
    assert.equal(ndfList[0].totalIndemnitesKilometriques, 600);
  });

  it(&apos;should get rapport&apos;, () =&gt; {
    const compte = compteService.find(idCompte);
    let rapport = noteDeFraisService.getRapport(compte);
    assert.deepEqual(rapport, [
      { status: &apos;inProgress&apos;, num: &apos;0 devise&apos; },
      { status: &apos;validated&apos;, num: 10 }
    ]);

  });

});
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.4.8)</span></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
